import{h as u,i as l,j as w}from"./BjvSjcul.js";import{l as v,q as S,d as _,E as c,p as R,P as $,S as E,a as h,b as T,D as L}from"./CFWGTvxy.js";const k=$["#f"]?.[0];let g=w(null),A=w(!0),P=w(!1);function x(){return u(A)}function C(){return u(P)}function F(){return v(async()=>{const r={kinds:[c.APP_STACK]};k&&(r["#f"]=[k]);const d=await S(r);if(d.length===0)return[];const a=d.map(_),n=new Map;for(const t of a){if(!t?.pubkey||!t?.dTag)continue;const e=`${t.pubkey}:${t.dTag}`,s=n.get(e);(!s||t.createdAt!=null&&t.createdAt>(s.createdAt??0))&&n.set(e,t)}const f=[...n.values()],o=new Set;for(const t of f)if(t?.appRefs)for(const e of t.appRefs)e.kind===c.APP&&e.identifier&&o.add(e.identifier);let i=new Map;if(o.size>0){const t={kinds:[c.APP],"#d":[...o]};k&&(t["#f"]=[k]);const e=await S(t);for(const s of e){const y=s.tags?.find(b=>b[0]==="d")?.[1];if(!y)continue;const p=`${s.pubkey}:${y}`,m=i.get(p);(!m||s.created_at>m.created_at)&&i.set(p,s)}}return f.map(t=>{const e=[];if(t.appRefs)for(const s of t.appRefs){if(s.kind!==c.APP)continue;const y=`${s.pubkey}:${s.identifier}`,p=i.get(y);p&&e.push(R(p))}return{stack:t,apps:e}})})}function I(r){if(r&&r.length>0){if(u(g)===null){const a=r.filter(n=>n.kind===c.APP_STACK);if(a.length>0){const n=[...a].sort((o,i)=>i.created_at-o.created_at),f=n[n.length-1];l(g,f.created_at-1),l(A,a.length>=E)}}const d=h(r).catch(a=>console.error("[StacksStore] Seed persist failed:",a));return(async()=>{const a=L,n=new Set;for(const f of r){if(f.kind!==c.APP_STACK)continue;const o=_(f);if(o?.appRefs)for(const i of o.appRefs){if(i.kind!==c.APP||!i.pubkey||!i.identifier)continue;const t=`${i.pubkey}:${i.identifier}`;if(!n.has(t)){n.add(t);try{if((await S({kinds:[c.APP],authors:[i.pubkey],"#d":[i.identifier],limit:1})).length===0){const s=await T(a,i.pubkey,i.identifier);s&&await h([s]).catch(()=>{})}}catch{}}}}})(),d}return Promise.resolve()}async function D(r,d){if(!(u(P)||!u(A))&&!(typeof window>"u"||!navigator.onLine)){l(P,!0);try{const a={kinds:[c.APP_STACK],limit:E};u(g)!=null&&(a.until=u(g)),k&&(a["#f"]=[k]);const n=await r(d,a);if(n.length>0){await h(n).catch(o=>console.error("[StacksStore] Load more persist failed:",o));const f=n[n.length-1];l(g,f.created_at-1),l(A,n.length>=E),(async()=>{const o=new Set;for(const i of n){const t=_(i);if(t?.appRefs)for(const e of t.appRefs){if(e.kind!==c.APP||!e.pubkey||!e.identifier)continue;const s=`${e.pubkey}:${e.identifier}`;if(!o.has(s)){o.add(s);try{if((await S({kinds:[c.APP],authors:[e.pubkey],"#d":[e.identifier],limit:1})).length===0){const p=await T(d,e.pubkey,e.identifier);p&&await h([p]).catch(()=>{})}}catch{}}}}})()}else l(A,!1)}catch(a){console.error("[StacksStore] Load more failed:",a)}finally{l(P,!1)}}}export{F as c,x as g,C as i,D as l,I as s};
