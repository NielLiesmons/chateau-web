import{h as d,i,j as T}from"./BjvSjcul.js";import{l as $,q as k,p as b,E as P,P as I,a as w,A as m,f as _,D as S,b as L,c as x}from"./CFWGTvxy.js";const M=I["#f"]?.[0];let p=T(null),u=T(!0),v=T(!1),A=null;function K(){return d(u)}function C(){return d(v)}function R(n){const s=n.tags?.find(o=>o[0]==="i"&&typeof o[1]=="string");if(s)return s[1];const f=n.tags?.find(o=>o[0]==="d"&&typeof o[1]=="string");if(!f)return null;const[t]=f[1].split("@");return t||null}function N(){return $(async()=>{const n=await k({kinds:[P.RELEASE]});if(n.length===0)return[];const s=[],f=new Set;for(const a of n){const e=R(a);e&&!f.has(e)&&(f.add(e),s.push(e))}if(s.length===0)return[];const t={kinds:[P.APP],"#d":s};M&&(t["#f"]=[M]);const o=await k(t),g=new Map;for(const a of o){const e=a.tags?.find(r=>r[0]==="d")?.[1];if(!e)continue;const c=`${a.pubkey}:${e}`,y=g.get(c);(!y||a.created_at>y.created_at)&&g.set(c,a)}const l=new Map;for(const[a,e]of g){const c=a.split(":").slice(1).join(":");l.has(c)||l.set(c,e)}const E=new Set,h=[];for(const a of n){const e=R(a);if(!e)continue;const c=`${a.pubkey}:${e}`,y=g.get(c)??l.get(e);if(!y)continue;const r=`${y.pubkey}:${e}`;E.has(r)||(E.add(r),h.push(b(y)))}return h})}function O(n){return n&&n.length>0?w(n).catch(s=>console.error("[AppsStore] Seed persist failed:",s)):Promise.resolve()}function q(n,s){d(p)===null&&(i(p,n??null,!0),i(u,s??!0,!0))}async function B(){if(!(d(v)||!d(u))&&!(typeof window>"u"||!navigator.onLine)){i(v,!0);try{const n=new URLSearchParams({limit:String(m)});d(p)!=null&&n.set("cursor",String(d(p)));const s=await fetch(`/api/apps?${n}`);if(!s.ok)throw new Error(`API error: ${s.status}`);const f=await s.json();if(f.events?.length>0){if(await w(f.events).catch(t=>console.error("[AppsStore] Load more persist failed:",t)),i(p,f.cursor??null,!0),i(u,f.hasMore??!0,!0),f.hasMore===!1&&d(p)!=null)try{const t=await _(S,{limit:m,until:d(p)});if(t.length>0){await w(t).catch(()=>{});const o=new Set;for(const l of t){const h=(l.tags?.find(r=>r[0]==="a")?.[1]??"").split(":"),a=h[1],e=h[2];if(!a||!e)continue;const c=`${a}:${e}`;if(o.has(c))continue;if(o.add(c),(await k({kinds:[32267],authors:[a],"#d":[e],limit:1})).length===0){const r=await L(S,a,e);r&&await w([r]).catch(()=>{})}}const g=Math.min(...t.map(l=>l.created_at));i(p,g,!0),i(u,t.length>=m)}else i(u,!1)}catch(t){console.error("[AppsStore] Relay fallback (after API hasMore false) failed:",t),i(u,!1)}}else if(d(p)!=null)try{const t=await _(S,{limit:m,until:d(p)});if(t.length>0){await w(t).catch(()=>{});const o=new Set;for(const l of t){const h=(l.tags?.find(r=>r[0]==="a")?.[1]??"").split(":"),a=h[1],e=h[2];if(!a||!e)continue;const c=`${a}:${e}`;if(o.has(c))continue;if(o.add(c),(await k({kinds:[32267],authors:[a],"#d":[e],limit:1})).length===0){const r=await L(S,a,e);r&&await w([r]).catch(()=>{})}}const g=Math.min(...t.map(l=>l.created_at));i(p,g,!0),i(u,t.length>=m)}else i(u,!1)}catch(t){console.error("[AppsStore] Relay fallback failed:",t),i(u,!1)}else i(u,!1)}catch(n){console.error("[AppsStore] Load more failed:",n)}finally{i(v,!1)}}}async function D(){if(!(typeof window>"u"||!navigator.onLine))try{const n=await fetch(`/api/apps?limit=${m}`);if(!n.ok)return;const s=await n.json();s.events?.length>0&&await w(s.events).catch(()=>{})}catch{}}function G(){A||(A=setInterval(D,x))}function Q(){A&&(clearInterval(A),A=null)}export{G as a,Q as b,N as c,C as d,K as g,q as i,B as l,O as s};
